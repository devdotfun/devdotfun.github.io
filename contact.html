<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TitiBank Chat — Secure Image Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f9;margin:0;padding:20px}
    .wrap{max-width:820px;margin:18px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 26px rgba(10,20,30,0.06)}
    #messages{height:420px;overflow:auto;border-radius:8px;border:1px solid #e6e9ef;padding:12px;background:#fafbfd}
    .msg{margin-bottom:12px;padding:10px;border-radius:10px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.03)}
    .meta{font-weight:700;color:#042a57}
    .time{font-weight:400;font-size:12px;color:#666;margin-left:8px}
    #controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    #msgInput{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    button{padding:9px 12px;border-radius:8px;border:0;background:#e63946;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#042a57}
    .chat-img{max-width:320px;border-radius:8px;margin-top:8px;display:block}
    #emojiPicker{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
    #emojiPicker span{cursor:pointer;padding:6px;border-radius:6px;background:#f0f0f0}
    #status{margin-bottom:8px;color:#333}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>💬 TitiBank Chat</h2>
    <div id="status">Connecting...</div>

    <div id="usernameArea">
      <input id="usernameInput" placeholder="Enter username (required to send)" />
      <button id="saveUsernameBtn" class="secondary">Save</button>
      <button id="readOnlyBtn">Read Only</button>
    </div>

    <div id="messages" aria-live="polite"></div>

    <div id="controls" style="display:none">
      <input id="msgInput" placeholder="Type a message" />
      <button id="emojiToggle">😀</button>
      <input id="fileInput" type="file" accept="image/*" style="display:none" />
      <button id="imgBtn">📷</button>
      <button id="sendBtn">Send</button>
    </div>

    <div id="emojiPicker" style="display:none"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, child, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ====== Replace these Firebase config values if different ======
    const firebaseConfig = {
      apiKey: "AIzaSyAqcF-u7zaTc0CwgXORBNi0ehhYYMG5a6g",
      authDomain: "titibankpumpfun.firebaseapp.com",
      databaseURL: "https://titibankpumpfun-default-rtdb.firebaseio.com",
      projectId: "titibankpumpfun",
      storageBucket: "",
      messagingSenderId: "713215451720",
      appId: "1:713215451720:web:a9ead74e25448f431fee7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // DOM
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const controls = document.getElementById('controls');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const readOnlyBtn = document.getElementById('readOnlyBtn');
    const fileInput = document.getElementById('fileInput');
    const imgBtn = document.getElementById('imgBtn');
    const emojiToggle = document.getElementById('emojiToggle');
    const emojiPicker = document.getElementById('emojiPicker');

    let currentUser = null;
    let canSend = false;

    // Emoji list
    const emojis = ["😀","😁","😂","🤣","😊","😍","😎","😢","😡","👍","🙏","🔥","❤️","🤝","🎉"];
    emojis.forEach(e => {
      const s = document.createElement('span');
      s.textContent = e;
      s.title = e;
      s.addEventListener('click', ()=> {
        msgInput.value += e;
        msgInput.focus();
        emojiPicker.style.display = 'none';
      });
      emojiPicker.appendChild(s);
    });
    emojiToggle.addEventListener('click', ()=> {
      emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
    });

    // Firebase anonymous auth
    signInAnonymously(auth).catch(err => {
      console.error("Auth error:", err);
      statusEl.textContent = "Auth error: " + err.message;
    });

    onAuthStateChanged(auth, async (user) => {
      if(!user) return;
      currentUser = { uid: user.uid, username: null };
      statusEl.textContent = "Connected";

      // check stored username in DB
      const snap = await get(child(ref(db), 'users/' + user.uid));
      if(snap.exists()){
        currentUser.username = snap.val().username;
        openChat();
      }

      // realtime messages listener
      onChildAdded(ref(db, 'messages'), (snap) => {
        appendMessage(snap.val());
      });
    });

    function openChat(){
      document.getElementById('usernameArea').style.display = 'none';
      controls.style.display = 'flex';
      canSend = true;
    }

    saveUsernameBtn.addEventListener('click', async ()=> {
      const name = usernameInput.value.trim();
      if(!name || name.length < 2) { alert("Enter a username (min 2 chars)"); return; }
      await set(ref(db, 'users/' + currentUser.uid), { username: name });
      currentUser.username = name;
      openChat();
    });

    readOnlyBtn.addEventListener('click', ()=> {
      document.getElementById('usernameArea').style.display = 'none';
      controls.style.display = 'none';
      canSend = false;
    });

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

    async function sendMessage(){
      if(!canSend){ alert("Set a username to send messages"); return; }
      const text = msgInput.value.trim();
      if(!text) return;
      await push(ref(db, 'messages'), {
        uid: currentUser.uid,
        username: currentUser.username,
        text,
        ts: Date.now(),
        type: "text"
      });
      msgInput.value = '';
    }

    function appendMessage(msg){
      const div = document.createElement('div');
      div.className = 'msg';
      const t = new Date(msg.ts || Date.now()).toLocaleTimeString();
      const meta = `<div class="meta">${escapeHtml(msg.username || 'Unknown')} <span class="time">${t}</span></div>`;
      div.innerHTML = meta;
      if(msg.type === 'image'){
        const img = document.createElement('img');
        img.className = 'chat-img';
        img.src = msg.text;
        img.alt = 'image';
        div.appendChild(img);
      } else {
        const p = document.createElement('div');
        p.textContent = msg.text;
        div.appendChild(p);
      }
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ===== Image upload flow using secure backend auth =====
    imgBtn.addEventListener('click', ()=> fileInput.click());

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return alert("Select an image");
      if(!canSend) return alert("Set a username to upload images");

      // 1) Get auth tokens from backend function
      statusEl.textContent = "Preparing upload...";
      try {
        // <<< IMPORTANT: replace this URL with your deployed Cloud Function URL (see steps) >>>
        const AUTH_ENDPOINT_BASE = "REPLACE_WITH_YOUR_CLOUD_FUNCTION_BASE_URL"; 
        // then the frontend will call: `${AUTH_ENDPOINT_BASE}/get-imagekit-auth`
        const r = await fetch(`${AUTH_ENDPOINT_BASE}/get-imagekit-auth`);
        if(!r.ok) throw new Error("Auth endpoint error: "+r.status);
        const authJson = await r.json();
        const { token, expire, signature, publicKey, folder } = authJson;
        if(!token || !signature) throw new Error("Invalid auth response");

        // 2) upload to ImageKit
        const form = new FormData();
        form.append("file", file);
        form.append("fileName", file.name);
        form.append("publicKey", publicKey);
        form.append("token", token);
        form.append("expire", expire);
        form.append("signature", signature);
        if(folder) form.append("folder", folder);

        statusEl.textContent = "Uploading image...";
        const uploadRes = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
          method: "POST",
          body: form
        });

        const uploadJson = await uploadRes.json();
        if(!uploadRes.ok){
          console.error("Upload failed:", uploadJson);
          alert("Image upload failed: " + (uploadJson.message || JSON.stringify(uploadJson)));
          statusEl.textContent = "Connected";
          return;
        }

        const imageUrl = uploadJson.url || uploadJson.filePath || null;
        if(!imageUrl){
          alert("Upload succeeded but no URL returned");
          statusEl.textContent = "Connected";
          return;
        }

        // 3) Push image message to Firebase
        await push(ref(db, 'messages'), {
          uid: currentUser.uid,
          username: currentUser.username,
          text: imageUrl,
          ts: Date.now(),
          type: "image"
        });

        statusEl.textContent = "Connected";
        fileInput.value = "";
      } catch (err) {
        console.error("Upload flow error:", err);
        alert("Image upload failed: " + err.message);
        statusEl.textContent = "Connected";
      }
    });

  </script>
</body>
</html>
