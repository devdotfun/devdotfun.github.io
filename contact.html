<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat (Text + Emoji + Images)</title>
  <style>
    body{font-family:Arial,sans-serif; background:#f4f4f9; margin:0; padding:20px;}
    .wrap{max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    #messages{height:400px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:10px;}
    .msg{margin-bottom:10px; padding:6px 10px; background:#f9f9f9; border-radius:6px;}
    .meta{font-weight:bold; font-size:13px;}
    .time{font-size:11px; color:#666; margin-left:5px;}
    #controls{display:flex; gap:5px; margin-bottom:10px;}
    #msgInput{flex:1; padding:8px;}
    button{padding:8px 12px; cursor:pointer;}
    emoji-picker {width:100%; max-width:300px; height:250px; border:1px solid #ccc; margin-top:10px;}
    img.chat-img {max-width:200px; border-radius:6px; margin-top:5px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ðŸ’¬ Live Chat (Text + Emoji + Images)</h2>
    <div id="status">Connecting...</div>

    <div id="usernameArea">
      <input id="usernameInput" placeholder="Enter username to send messages"/>
      <button id="saveUsernameBtn">Save</button>
      <button id="readOnlyBtn">Read Only</button>
    </div>

    <div id="messages"></div>

    <div id="controls" style="display:none;">
      <input id="msgInput" placeholder="Type a message"/>
      <button id="sendBtn">Send</button>
    </div>

    <!-- Image upload controls -->
    <div id="imageControls" style="display:none; margin-bottom:10px;">
      <input type="file" id="imgInput" accept="image/*"/>
      <button id="sendImgBtn">Send Image</button>
    </div>

    <!-- Emoji Picker -->
    <emoji-picker id="emojiPicker"></emoji-picker>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, child, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import "https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js";

    // ðŸ”¹ Replace with your firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAqcF-u7zaTc0CwgXORBNi0ehhYYMG5a6g",
      authDomain: "titibankpumpfun.firebaseapp.com",
      databaseURL: "https://titibankpumpfun-default-rtdb.firebaseio.com",
      projectId: "titibankpumpfun",
      storageBucket: "titibankpumpfun.appspot.com",
      messagingSenderId: "713215451720",
      appId: "1:713215451720:web:a9ead74e25448f431fee7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const controls = document.getElementById('controls');
    const imageControls = document.getElementById('imageControls');
    const imgInput = document.getElementById('imgInput');
    const sendImgBtn = document.getElementById('sendImgBtn');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const readOnlyBtn = document.getElementById('readOnlyBtn');
    const usernameArea = document.getElementById('usernameArea');
    const emojiPicker = document.getElementById('emojiPicker');

    let currentUser = null;
    let canSend = false;

    // ðŸ”¹ ImgBB API key (yours)
    const IMGBB_API_KEY = "b18bfa52d4d86e629b539959405ee388";

    signInAnonymously(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      currentUser = { uid: user.uid, username: null };
      statusEl.textContent = "Connected";

      const snap = await get(child(ref(db), 'users/' + user.uid));
      if(snap.exists()){
        currentUser.username = snap.val().username;
        enableChat();
      }

      onChildAdded(ref(db, 'messages'), (snap)=>{
        appendMessage(snap.val());
      });
    });

    function enableChat(){
      usernameArea.style.display = "none";
      controls.style.display = "flex";
      imageControls.style.display = "block";
      canSend = true;
    }

    saveUsernameBtn.addEventListener('click', async ()=>{
      const name = usernameInput.value.trim();
      if(!name){ alert("Enter a username"); return; }
      await set(ref(db, 'users/' + currentUser.uid), { username: name });
      currentUser.username = name;
      enableChat();
    });

    readOnlyBtn.addEventListener('click', ()=>{
      usernameArea.style.display = "none";
      controls.style.display = "none";
      imageControls.style.display = "none";
      canSend = false;
    });

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e=>{ if(e.key==="Enter") sendMessage(); });

    async function sendMessage(){
      if(!canSend){ alert("Set a username first!"); return; }
      const text = msgInput.value.trim();
      if(!text) return;
      await push(ref(db, 'messages'), { 
        uid: currentUser.uid,
        username: currentUser.username,
        text, 
        ts: Date.now(),
        type: "text"
      });
      msgInput.value = '';
    }

    // ðŸ”¹ Emoji Picker add to input
    emojiPicker.addEventListener("emoji-click", event => {
      msgInput.value += event.detail.unicode;
      msgInput.focus();
    });

    // ðŸ”¹ Image sending with ImgBB
    sendImgBtn.addEventListener("click", async ()=>{
      if(!canSend){ alert("Set a username first!"); return; }
      const file = imgInput.files[0];
      if(!file){ alert("Select an image first!"); return; }

      const formData = new FormData();
      formData.append("image", file);

      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if(data.success){
        const url = data.data.url;
        await push(ref(db, 'messages'), { 
          uid: currentUser.uid,
          username: currentUser.username,
          image: url,
          ts: Date.now(),
          type: "image"
        });
        imgInput.value = null;
      } else {
        alert("Image upload failed!");
      }
    });

    // ðŸ”¹ Show messages
    function appendMessage(msg){
      const div = document.createElement('div');
      div.className = 'msg';
      const t = new Date(msg.ts).toLocaleTimeString();
      div.innerHTML = `<div class="meta">${msg.username||"??"} <span class="time">${t}</span></div>`;
      
      if(msg.type === "text"){
        div.innerHTML += `<div>${msg.text}</div>`;
      } else if(msg.type === "image"){
        div.innerHTML += `<div><img class="chat-img" src="${msg.image}"/></div>`;
      }

      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
