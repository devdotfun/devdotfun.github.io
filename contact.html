<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat (Text Only)</title>
  <style>
    body{font-family:Arial,sans-serif; background:#f4f4f9; margin:0; padding:20px;}
    .wrap{max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    #messages{height:400px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:10px;}
    .msg{margin-bottom:10px; padding:6px 10px; background:#f9f9f9; border-radius:6px;}
    .meta{font-weight:bold; font-size:13px;}
    .time{font-size:11px; color:#666; margin-left:5px;}
    #controls{display:flex; gap:5px;}
    #msgInput{flex:1; padding:8px;}
    button{padding:8px 12px; cursor:pointer;}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ðŸ’¬ Live Chat (Text Only)</h2>
    <div id="status">Connecting...</div>

    <div id="usernameArea">
      <input id="usernameInput" placeholder="Enter username to send messages"/>
      <button id="saveUsernameBtn">Save</button>
      <button id="readOnlyBtn">Read Only</button>
    </div>

    <div id="messages"></div>

    <div id="controls" style="display:none;">
      <input id="msgInput" placeholder="Type a message"/>
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, child, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ðŸ”¹ Replace with your firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyAqcF-u7zaTc0CwgXORBNi0ehhYYMG5a6g",
      authDomain: "titibankpumpfun.firebaseapp.com",
      databaseURL: "https://titibankpumpfun-default-rtdb.firebaseio.com",
      projectId: "titibankpumpfun",
      storageBucket: "titibankpumpfun.appspot.com",
      messagingSenderId: "713215451720",
      appId: "1:713215451720:web:a9ead74e25448f431fee7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const controls = document.getElementById('controls');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const readOnlyBtn = document.getElementById('readOnlyBtn');
    const usernameArea = document.getElementById('usernameArea');

    let currentUser = null;
    let canSend = false;

    signInAnonymously(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      currentUser = { uid: user.uid, username: null };
      statusEl.textContent = "Connected";

      const snap = await get(child(ref(db), 'users/' + user.uid));
      if(snap.exists()){
        currentUser.username = snap.val().username;
        enableChat();
      }

      onChildAdded(ref(db, 'messages'), (snap)=>{
        appendMessage(snap.val());
      });
    });

    function enableChat(){
      usernameArea.style.display = "none";
      controls.style.display = "flex";
      canSend = true;
    }

    saveUsernameBtn.addEventListener('click', async ()=>{
      const name = usernameInput.value.trim();
      if(!name){ alert("Enter a username"); return; }
      await set(ref(db, 'users/' + currentUser.uid), { username: name });
      currentUser.username = name;
      enableChat();
    });

    readOnlyBtn.addEventListener('click', ()=>{
      usernameArea.style.display = "none";
      controls.style.display = "none";
      canSend = false;
    });

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e=>{ if(e.key==="Enter") sendMessage(); });

    async function sendMessage(){
      if(!canSend){ alert("Set a username first!"); return; }
      const text = msgInput.value.trim();
      if(!text) return;
      await push(ref(db, 'messages'), { 
        uid: currentUser.uid,
        username: currentUser.username,
        text, 
        ts: Date.now(),
        type: "text"
      });
      msgInput.value = '';
    }

    function appendMessage(msg){
      const div = document.createElement('div');
      div.className = 'msg';
      const t = new Date(msg.ts).toLocaleTimeString();
      div.innerHTML = `<div class="meta">${msg.username||"??"} <span class="time">${t}</span></div>
                       <div>${msg.text}</div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
