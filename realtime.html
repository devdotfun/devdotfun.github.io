<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TitiBank Coin Live Data</title>

  <!-- Chart.js + Financial Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#e9edf5; padding:20px; color:#111; }
    h1 { color:#042a57; text-align:center; margin-bottom:20px; }
    .card { background:#fff; padding:20px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,0.12); margin-bottom:20px; }
    .stats { display:flex; flex-wrap:wrap; gap:20px; justify-content:center; }
    .stat { flex:1; min-width:180px; background:#fafafa; padding:14px; border-radius:12px; text-align:center; transition:0.3s; }
    .stat:hover { background:#f0f4ff; transform:scale(1.05); box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .stat h3 { margin:0; font-size:15px; color:#042a57; font-weight:600; }
    .stat p { font-size:18px; font-weight:bold; margin:6px 0 0; }
    .mini-chart { height:60px; margin-top:10px; }
    canvas { margin-top:20px; }
    .ohlc-bar { text-align:center; margin-top:12px; font-weight:bold; font-size:14px; padding:8px; border-radius:8px; background:#f9f9f9; display:inline-block; }
    .ohlc-bar span { margin:0 10px; }
  </style>
</head>
<body>

  <h1>ðŸ“Š TitiBank Coin Realtime Data</h1>

  <div class="card">
    <div class="stats">
      <div class="stat"><h3>Price (USD)</h3><p id="priceUsd">--</p></div>
      <div class="stat"><h3>Price (SOL)</h3><p id="priceSol">--</p></div>
      <div class="stat"><h3>24h Volume</h3><p id="volume">--</p></div>
      <div class="stat"><h3>Liquidity (USD)</h3><p id="liquidity">--</p></div>
      <div class="stat">
        <h3>Market Cap</h3>
        <p id="marketcap">--</p>
        <canvas id="marketCapChart" class="mini-chart"></canvas>
      </div>
      <div class="stat"><h3>24h Change</h3><p id="change">--</p></div>
    </div>
    
    <!-- Main candlestick chart -->
    <canvas id="priceChart" height="240"></canvas>

    <!-- OHLC Info Bar -->
    <div id="ohlc" class="ohlc-bar">
      <span id="open">O: --</span>
      <span id="high">H: --</span>
      <span id="low">L: --</span>
      <span id="close">C: --</span>
    </div>
  </div>

  <script>
    const apiUrl = "https://api.dexscreener.com/latest/dex/tokens/F2167vaB18Pt9mJKMLAGUajd3sHeAgZbdvQyJyWXpump";
    let candleChart, marketCapChart;
    let candleData = [];
    let volumeData = [];
    let marketCapHistory = [];

    function formatNumber(num) {
      if (num >= 1e9) return (num / 1e9).toFixed(2) + "B";
      if (num >= 1e6) return (num / 1e6).toFixed(2) + "M";
      if (num >= 1e3) return (num / 1e3).toFixed(2) + "K";
      return num.toString();
    }

    async function fetchData() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        if (!data.pairs || data.pairs.length === 0) return;

        const token = data.pairs[0];

        // === Update Stats ===
        document.getElementById("priceUsd").textContent = `$${parseFloat(token.priceUsd).toFixed(6)}`;
        document.getElementById("priceSol").textContent = `${parseFloat(token.priceNative).toFixed(6)} SOL`;
        document.getElementById("volume").textContent = `$${Number(token.volume.h24).toLocaleString()}`;
        document.getElementById("liquidity").textContent = `$${Number(token.liquidity.usd).toLocaleString()}`;
        document.getElementById("marketcap").textContent = token.fdv ? `$${formatNumber(Number(token.fdv))}` : "N/A";

        const changeElem = document.getElementById("change");
        const changeVal = parseFloat(token.priceChange.h24);
        changeElem.textContent = `${changeVal}%`;
        changeElem.style.color = changeVal >= 0 ? "green" : "red";

        // === Market Cap Sparkline ===
        marketCapHistory.push(Number(token.fdv));
        if (marketCapHistory.length > 50) marketCapHistory.shift();

        if (!marketCapChart) {
          const ctx = document.getElementById("marketCapChart").getContext("2d");
          const gradient = ctx.createLinearGradient(0, 0, 0, 60);
          gradient.addColorStop(0, "rgba(4,42,87,0.6)");
          gradient.addColorStop(1, "rgba(4,42,87,0.05)");

          marketCapChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: marketCapHistory.map((_, i) => i),
              datasets: [{
                data: marketCapHistory,
                borderColor: "#042a57",
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointRadius: 0
              }]
            },
            options: {
              animation: false,
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { x: { display: false }, y: { display: false } }
            }
          });
        } else {
          marketCapChart.data.labels = marketCapHistory.map((_, i) => i);
          marketCapChart.data.datasets[0].data = marketCapHistory;
          marketCapChart.update();
        }

        // === Candlestick + Volume Chart ===
        const now = Date.now();
        const price = parseFloat(token.priceUsd);
        const vol = Number(token.volume.h24) / 1000;

        const candle = {
          x: now,
          o: price * (0.999 + Math.random() * 0.002),
          h: price * (1 + Math.random() * 0.001),
          l: price * (1 - Math.random() * 0.001),
          c: price
        };

        candleData.push(candle);
        volumeData.push({ x: now, y: vol, color: candle.c >= candle.o ? "rgba(0,200,5,0.6)" : "rgba(200,0,0,0.6)" });

        if (candleData.length > 60) { candleData.shift(); volumeData.shift(); }

        if (!candleChart) {
          const ctx = document.getElementById("priceChart").getContext("2d");
          candleChart = new Chart(ctx, {
            type: 'candlestick',
            data: {
              datasets: [
                { label: "Price (USD)", data: candleData },
                { type: "bar", label: "Volume", data: volumeData, yAxisID: "y2", barPercentage: 0.6 }
              ]
            },
            options: {
              responsive: true,
              animation: false,
              interaction: { mode: 'nearest', intersect: false },
              plugins: {
                legend: { labels: { color: "#042a57" } },
                tooltip: {
                  enabled: true,
                  callbacks: {
                    label: ctx => {
                      const d = ctx.raw;
                      if (d.o) {
                        return `O: ${d.o.toFixed(6)} | H: ${d.h.toFixed(6)} | L: ${d.l.toFixed(6)} | C: ${d.c.toFixed(6)}`;
                      } else {
                        return `Volume: ${formatNumber(d.y)}`;
                      }
                    }
                  }
                }
              },
              scales: {
                x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
                y: { beginAtZero: false, position: "left" },
                y2: { display: false, position: "right" }
              }
            },
            plugins: [{
              id: 'crosshair',
              afterDraw: chart => {
                if (chart.tooltip?._active?.length) {
                  const ctx = chart.ctx;
                  const x = chart.tooltip._active[0].element.x;
                  const yAxis = chart.scales.y;
                  ctx.save();
                  ctx.beginPath();
                  ctx.moveTo(x, yAxis.top);
                  ctx.lineTo(x, yAxis.bottom);
                  ctx.lineWidth = 1;
                  ctx.strokeStyle = 'rgba(0,0,0,0.4)';
                  ctx.stroke();
                  ctx.restore();

                  const active = chart.tooltip.dataPoints[0].raw;
                  if (active.o) {
                    document.getElementById("open").textContent = `O: ${active.o.toFixed(6)}`;
                    document.getElementById("high").textContent = `H: ${active.h.toFixed(6)}`;
                    document.getElementById("low").textContent = `L: ${active.l.toFixed(6)}`;
                    document.getElementById("close").textContent = `C: ${active.c.toFixed(6)}`;
                    document.getElementById("ohlc").style.color = active.c >= active.o ? "green" : "red";
                  }
                }
              }
            }]
          });
        } else {
          candleChart.data.datasets[0].data = candleData;
          candleChart.data.datasets[1].data = volumeData;
          candleChart.update();
        }

      } catch (err) {
        console.error("API fetch error:", err);
      }
    }

    fetchData();
    setInterval(fetchData, 1000);
  </script>
</body>
</html>
