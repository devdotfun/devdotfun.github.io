<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TitiBank - Live Chat </title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f9;margin:0;padding:18px}
    .wrap{max-width:860px;margin:18px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 26px rgba(10,20,30,0.06)}
    h1{margin:0 0 8px 0;color:#042a57}
    #status{color:#333;margin-bottom:8px}
    #usernameArea{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    #usernameInput{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    button{padding:9px 12px;border-radius:8px;border:0;background:#e63946;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#042a57}
    #messages{height:520px;overflow:auto;border-radius:8px;border:1px solid #e6e9ef;padding:12px;background:#fafbfd}
    .msg-row{display:flex;gap:10px;margin-bottom:12px;align-items:flex-start}
    .avatar{width:42px;height:42px;border-radius:50%;flex:0 0 42px}
    .bubble{background:#fff;padding:10px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.03);min-width:80px;max-width:74%}
    .meta{font-weight:700;color:#042a57;margin-bottom:6px}
    .time{font-weight:400;color:#666;font-size:12px;margin-left:8px}
    .chat-img{max-width:320px;border-radius:8px;display:block;margin-top:8px}
    .caption{color:#222;margin-top:6px;font-size:14px}
    .sending{opacity:0.6;font-style:italic;color:#666}
    .controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    #msgInput{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    #emojiPicker{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    #emojiPicker span{cursor:pointer;padding:6px;border-radius:6px;background:#f0f0f0}
    .reactions {margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .reaction-btn{padding:4px 8px;border-radius:14px;background:#f6f6f6;cursor:pointer; font-size:13px}
    .reaction-btn.you{background:#dfeffd}
    .small-muted{font-size:12px;color:#666;margin-left:6px}
    .caption-input{width:100%;padding:8px;border-radius:8px;border:1px solid #eee;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>💬 TitiBank Chat</h1>
    <div id="status">Connecting...</div>

    <div id="usernameArea">
      <input id="usernameInput" placeholder="Choose username (required to send)"/>
      <button id="saveUsernameBtn" class="secondary">Save</button>
      <button id="readOnlyBtn">Read Only</button>
    </div>

    <div id="messages" aria-live="polite"></div>

    <div id="compose" style="display:none">
      <div class="controls">
        <input id="msgInput" placeholder="Write a message (or send caption with image)"/>
        <button id="emojiToggle">😀</button>
        <input id="fileInput" type="file" accept="image/*" style="display:none" />
        <button id="imgBtn">📷</button>
        <button id="sendBtn">Send</button>
      </div>
      <div id="emojiPicker" style="display:none"></div>
      <input id="captionInput" class="caption-input" placeholder="Caption for next image (optional)"/>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, set, child, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // 🔥 Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqcF-u7zaTc0CwgXORBNi0ehhYYMG5a6g",
      authDomain: "titibankpumpfun.firebaseapp.com",
      databaseURL: "https://titibankpumpfun-default-rtdb.firebaseio.com",
      projectId: "titibankpumpfun",
      storageBucket: "",
      messagingSenderId: "713215451720",
      appId: "1:713215451720:web:a9ead74e25448f431fee7d"
    };

    // ✅ ImageKit setup (testing mode ON)
    const USE_PRIVATE_KEY_FOR_IMGKIT = true; 
    const IMAGEKIT_PRIVATE_KEY = "private_k4q1Dj0mdO7laABQ/3DNodwATfA="; 
    const IMAGEKIT_PUBLIC_KEY = "public_6MDkzxKFxdmlY1RsT/NsiyTLMmo=";
    const IMAGEKIT_FOLDER = "chat_images"; 

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const readOnlyBtn = document.getElementById('readOnlyBtn');
    const compose = document.getElementById('compose');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const emojiToggle = document.getElementById('emojiToggle');
    const emojiPicker = document.getElementById('emojiPicker');
    const fileInput = document.getElementById('fileInput');
    const imgBtn = document.getElementById('imgBtn');
    const captionInput = document.getElementById('captionInput');

    let currentUser = null;
    let canSend = false;

    // Emoji Picker
    const emojis = ["😀","😁","😂","🤣","😊","😍","😎","😢","😡","👍","🙏","🔥","❤️"];
    emojis.forEach(e=>{
      const s=document.createElement('span');
      s.textContent=e;
      s.onclick=()=>{ msgInput.value+=e; emojiPicker.style.display='none'; };
      emojiPicker.appendChild(s);
    });
    emojiToggle.onclick=()=>{ emojiPicker.style.display=emojiPicker.style.display==='flex'?'none':'flex'; emojiPicker.style.flexWrap='wrap'; };

    function avatarFor(name){ return `https://avatars.dicebear.com/api/identicon/${encodeURIComponent(name)}.svg`; }

    signInAnonymously(auth);
    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      currentUser={ uid:user.uid, username:null, avatar:null };
      statusEl.textContent="Connected";

      const snap=await get(child(ref(db),'users/'+user.uid));
      if(snap.exists()){
        const d=snap.val(); 
        currentUser.username=d.username; 
        currentUser.avatar=d.avatar||avatarFor(d.username); 
        openChat();
      }
      onChildAdded(ref(db,'messages'),s=>renderMessage(s.key,s.val()));
      onChildChanged(ref(db,'messages'),s=>updateMessageDom(s.key,s.val()));
      onChildRemoved(ref(db,'messages'),s=>removeMessageDom(s.key));
    });

    saveUsernameBtn.onclick=async()=>{
      const name=usernameInput.value.trim();
      if(!name) return alert("Enter username");
      const avatar=avatarFor(name);
      await set(ref(db,'users/'+currentUser.uid),{username:name,avatar});
      currentUser.username=name; currentUser.avatar=avatar; openChat();
    };
    readOnlyBtn.onclick=()=>{ document.getElementById('usernameArea').style.display='none'; compose.style.display='none'; canSend=false; };
    function openChat(){ document.getElementById('usernameArea').style.display='none'; compose.style.display='block'; canSend=true; }

    sendBtn.onclick=sendMessage;
    msgInput.onkeydown=e=>{ if(e.key==="Enter") sendMessage(); };
    async function sendMessage(){
      if(!canSend) return alert("Set username first");
      const text=msgInput.value.trim(); if(!text) return;
      await push(ref(db,'messages'),{uid:currentUser.uid,username:currentUser.username,avatar:currentUser.avatar,type:'text',text,ts:Date.now()});
      msgInput.value='';
    }

    imgBtn.onclick=()=>fileInput.click();
    fileInput.onchange=async e=>{
      const file=e.target.files[0]; if(!file||!canSend) return;
      const placeholder={uid:currentUser.uid,username:currentUser.username,avatar:currentUser.avatar,type:'image',text:'',caption:captionInput.value.trim(),ts:Date.now(),status:'uploading'};
      const newRef=await push(ref(db,'messages'),placeholder);
      const messageKey=newRef.key;
      try{
        const form=new FormData();
        form.append('file',file);
        form.append('fileName',file.name);
        if(IMAGEKIT_FOLDER) form.append('folder',IMAGEKIT_FOLDER);
        const authHeader="Basic "+btoa(IMAGEKIT_PRIVATE_KEY+":");
        const uploadRes=await fetch("https://upload.imagekit.io/api/v1/files/upload",{method:"POST",headers:{Authorization:authHeader},body:form});
        const uploadJson=await uploadRes.json();
        if(!uploadRes.ok) throw new Error(JSON.stringify(uploadJson));
        const imageUrl=uploadJson.url;
        await update(ref(db,'messages/'+messageKey),{text:imageUrl,status:'sent',ts:Date.now()});
        captionInput.value='';
      }catch(err){ console.error(err); await update(ref(db,'messages/'+messageKey),{status:'failed'}); alert("Image upload failed: "+err.message); }
    };

    async function toggleReaction(msgId,emoji){
      if(!currentUser) return;
      const userReactRef=ref(db,`messages/${msgId}/reactions/${currentUser.uid}`);
      const snap=await get(child(ref(db),`messages/${msgId}/reactions/${currentUser.uid}`));
      const existing=snap.exists()?snap.val():null;
      await set(userReactRef, existing===emoji?null:emoji);
    }

    const domMap=new Map();
    function renderMessage(msgId,msg){
      if(domMap.has(msgId)) return updateMessageDom(msgId,msg);
      const row=document.createElement('div'); row.className='msg-row'; row.id='msg-'+msgId;
      const avatar=document.createElement('img'); avatar.className='avatar'; avatar.src=msg.avatar||avatarFor(msg.username||'anon');
      const bubble=document.createElement('div'); bubble.className='bubble';
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`${msg.username||'Unknown'} <span class="small-muted">${new Date(msg.ts).toLocaleTimeString()}</span>`;
      const content=document.createElement('div');
      if(msg.type==='image'){
        if(msg.status==='uploading'){ content.innerHTML='<div class="sending">📤 Sending image...</div>'; }
        else if(msg.status==='failed'){ content.innerHTML='<div class="sending">❌ Upload failed</div>'; }
        else{ if(msg.text) content.innerHTML+=`<img class="chat-img" src="${msg.text}"/>`; if(msg.caption) content.innerHTML+=`<div class="caption">${msg.caption}</div>`; }
      }else{ content.textContent=msg.text||''; }
      const reactionsWrap=document.createElement('div'); reactionsWrap.className='reactions';
      ["👍","❤️","😂","🔥"].forEach(em=>{ const rb=document.createElement('div'); rb.className='reaction-btn'; rb.textContent=em; rb.onclick=()=>toggleReaction(msgId,em); reactionsWrap.appendChild(rb); });
      const agg=document.createElement('div'); agg.className='agg'; reactionsWrap.appendChild(agg);
      bubble.appendChild(meta); bubble.appendChild(content); bubble.appendChild(reactionsWrap);
      row.appendChild(avatar); row.appendChild(bubble);
      messagesEl.appendChild(row); messagesEl.scrollTop=messagesEl.scrollHeight;
      domMap.set(msgId,{row,content,agg}); renderAggregatedReactions(msgId,msg);
    }
    function updateMessageDom(msgId,msg){
      const m=domMap.get(msgId); if(!m) return renderMessage(msgId,msg);
      m.content.innerHTML='';
      if(msg.type==='image'){
        if(msg.status==='uploading') m.content.innerHTML='<div class="sending">📤 Sending image...</div>';
        else if(msg.status==='failed') m.content.innerHTML='<div class="sending">❌ Upload failed</div>';
        else{ if(msg.text) m.content.innerHTML+=`<img class="chat-img" src="${msg.text}"/>`; if(msg.caption) m.content.innerHTML+=`<div class="caption">${msg.caption}</div>`; }
      }else m.content.textContent=msg.text||'';
      renderAggregatedReactions(msgId,msg);
    }
    function removeMessageDom(msgId){ const m=domMap.get(msgId); if(m){ m.row.remove(); domMap.delete(msgId);} }
    function renderAggregatedReactions(msgId,msg){
      const m=domMap.get(msgId); if(!m) return;
      m.agg.innerHTML=''; const reactions=msg.reactions||{}; const counts={};
      for(const uid in reactions){ const em=reactions[uid]; if(em) counts[em]=(counts[em]||0)+1; }
      Object.keys(counts).forEach(em=>{ const btn=document.createElement('div'); btn.className='reaction-btn'; if(msg.reactions&&currentUser&&msg.reactions[currentUser.uid]===em) btn.classList.add('you'); btn.textContent=`${em} ${counts[em]}`; btn.onclick=()=>toggleReaction(msgId,em); m.agg.appendChild(btn); });
    }
  </script>
</body>
</html>
