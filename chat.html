<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chat (Live)</title>
  <style>
    body{font-family:Arial,sans-serif; background:#f4f4f9; margin:0; padding:20px;}
    .wrap{max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    #messages{height:400px; overflow-y:auto; border:1px solid #ddd; padding:10px; margin-bottom:10px;}
    .msg{margin-bottom:10px; padding:6px 10px; background:#f9f9f9; border-radius:6px;}
    .meta{font-weight:bold; font-size:13px;}
    .time{font-size:11px; color:#666; margin-left:5px;}
    #controls{display:flex; gap:5px; margin-top:10px;}
    #msgInput{flex:1; padding:8px;}
    button{padding:8px 12px; cursor:pointer;}
    #emojiPicker{position:absolute; bottom:60px; background:#fff; border:1px solid #ccc; padding:5px; display:none; flex-wrap:wrap; max-width:200px;}
    #emojiPicker span{cursor:pointer; padding:5px;}
    img.chat-img{max-width:200px; border-radius:6px; margin-top:5px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>ðŸ’¬ Live Chat (With Emoji + Images)</h2>
    <div id="status">Connecting...</div>

    <div id="usernameArea">
      <input id="usernameInput" placeholder="Enter username to send messages"/>
      <button id="saveUsernameBtn">Save</button>
      <button id="readOnlyBtn">Read Only</button>
    </div>

    <div id="messages"></div>

    <div id="controls" style="display:none;">
      <input id="msgInput" placeholder="Type a message"/>
      <button id="emojiBtn">ðŸ˜€</button>
      <input type="file" id="imgInput" accept="image/*" style="display:none;"/>
      <button id="imgBtn">ðŸ“·</button>
      <button id="sendBtn">Send</button>
    </div>

    <div id="emojiPicker"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, set, child, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAqcF-u7zaTc0CwgXORBNi0ehhYYMG5a6g",
      authDomain: "titibankpumpfun.firebaseapp.com",
      databaseURL: "https://titibankpumpfun-default-rtdb.firebaseio.com",
      projectId: "titibankpumpfun",
      storageBucket: "titibankpumpfun.appspot.com",
      messagingSenderId: "713215451720",
      appId: "1:713215451720:web:a9ead74e25448f431fee7d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const controls = document.getElementById('controls');
    const usernameInput = document.getElementById('usernameInput');
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    const readOnlyBtn = document.getElementById('readOnlyBtn');
    const usernameArea = document.getElementById('usernameArea');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const imgBtn = document.getElementById('imgBtn');
    const imgInput = document.getElementById('imgInput');

    let currentUser = null;
    let canSend = false;

    signInAnonymously(auth);

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      currentUser = { uid: user.uid, username: null };
      statusEl.textContent = "Connected";

      const snap = await get(child(ref(db), 'users/' + user.uid));
      if(snap.exists()){
        currentUser.username = snap.val().username;
        enableChat();
      }

      onChildAdded(ref(db, 'messages'), (snap)=>{
        appendMessage(snap.val());
      });
    });

    function enableChat(){
      usernameArea.style.display = "none";
      controls.style.display = "flex";
      canSend = true;
    }

    saveUsernameBtn.addEventListener('click', async ()=>{
      const name = usernameInput.value.trim();
      if(!name){ alert("Enter a username"); return; }
      await set(ref(db, 'users/' + currentUser.uid), { username: name });
      currentUser.username = name;
      enableChat();
    });

    readOnlyBtn.addEventListener('click', ()=>{
      usernameArea.style.display = "none";
      controls.style.display = "none";
      canSend = false;
    });

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e=>{ if(e.key==="Enter") sendMessage(); });

    async function sendMessage(){
      if(!canSend){ alert("Set a username first!"); return; }
      const text = msgInput.value.trim();
      if(!text) return;
      await push(ref(db, 'messages'), { 
        uid: currentUser.uid,
        username: currentUser.username,
        text, 
        ts: Date.now(),
        type: "text"
      });
      msgInput.value = '';
    }

    function appendMessage(msg){
      const div = document.createElement('div');
      div.className = 'msg';
      const t = new Date(msg.ts).toLocaleTimeString();
      div.innerHTML = `<div class="meta">${msg.username||"??"} <span class="time">${t}</span></div>`;
      if(msg.type === "image"){
        div.innerHTML += `<img src="${msg.text}" class="chat-img"/>`;
      } else {
        div.innerHTML += `<div>${msg.text}</div>`;
      }
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Emoji picker
    const emojis = ["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜","ðŸ˜Ž","ðŸ˜¢","ðŸ˜¡","ðŸ‘","ðŸ™","ðŸ”¥","â¤ï¸"];
    emojis.forEach(e=>{
      const span = document.createElement('span');
      span.textContent = e;
      span.onclick = ()=>{ msgInput.value += e; emojiPicker.style.display="none"; };
      emojiPicker.appendChild(span);
    });
    emojiBtn.addEventListener('click', ()=>{
      emojiPicker.style.display = emojiPicker.style.display==="flex"?"none":"flex";
    });

    // Image Upload with ImageKit (âš ï¸ private key test only)
    imgBtn.addEventListener('click', ()=> imgInput.click());

    async function uploadToImageKit(file){
      let formData = new FormData();
      formData.append("file", file);
      formData.append("fileName", file.name);

      const res = await fetch("https://upload.imagekit.io/api/v1/files/upload", {
        method: "POST",
        headers: {
          Authorization: "Basic " + btoa("private_k4q1Dj0mdO7laABQ/3DNodwATfA=" + ":"),
        },
        body: formData,
      });

      const data = await res.json();
      return data.url;
    }

    imgInput.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(file && canSend){
        const url = await uploadToImageKit(file);
        if(url){
          await push(ref(db, 'messages'), {
            uid: currentUser.uid,
            username: currentUser.username,
            text: url,
            ts: Date.now(),
            type: "image"
          });
        } else {
          alert("Image upload failed!");
        }
      }
    });

  </script>
</body>
</html>
